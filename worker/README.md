# RAG Chatbot — Cloudflare Worker

A Cloudflare Worker that powers the "Ask about my research" chat widget on the site. It uses Google Gemini for embeddings and generation, with a pre-built vector index of site content for retrieval-augmented generation.

## Architecture

```
Browser chat widget
        |
        v
Cloudflare Worker (this code)
  1. Embeds user query via Gemini embedding API
  2. Cosine-similarity search over pre-computed chunks (bundled JSON)
  3. Sends top-k chunks + query to Gemini for a grounded answer
  4. Returns the response
```

## Setup

### Prerequisites

- A [Cloudflare account](https://dash.cloudflare.com/sign-up) (free tier works)
- A [Google AI Studio API key](https://aistudio.google.com/apikey) for Gemini
- Node.js 18+

### 1. Install dependencies

```bash
cd worker
npm install
```

### 2. Build the RAG index

From the repo root, run the indexing script to embed all site content:

```bash
export GEMINI_API_KEY="your-gemini-api-key"
python scripts/build_rag_index.py
```

This reads your site content (profile, papers, blog posts, status) and generates `worker/src/rag_index.json` with text chunks and their embeddings.

### 3. Set the API key as a Worker secret

```bash
cd worker
npx wrangler secret put GEMINI_API_KEY
# Paste your Gemini API key when prompted
```

### 4. Deploy

```bash
npx wrangler deploy
```

This will output your Worker URL, e.g.:
```
https://ibrahim-research-chat.YOUR_SUBDOMAIN.workers.dev
```

### 5. Update the frontend

In `_layouts/default.html`, find the line:

```javascript
const CHAT_API = 'https://ibrahim-research-chat.YOUR_CF_SUBDOMAIN.workers.dev';
```

Replace `YOUR_CF_SUBDOMAIN` with your actual Cloudflare Workers subdomain.

### 6. (Optional) Configure CORS

In `wrangler.toml`, the `ALLOWED_ORIGIN` variable controls which domains can call the Worker. It defaults to `https://ibrahimkhan4real.github.io`. For local development, `http://localhost:4000` is also allowed.

## Local development

```bash
cd worker
npx wrangler dev
```

This runs the Worker locally at `http://localhost:8787`. You can test it with:

```bash
curl -X POST http://localhost:8787 \
  -H "Content-Type: application/json" \
  -d '{"query": "What is Ibrahim researching?"}'
```

## Updating the index

When you add new blog posts, papers, or update your profile, rebuild the index:

```bash
export GEMINI_API_KEY="your-key"
python scripts/build_rag_index.py
cd worker && npx wrangler deploy
```

## Files

| File | Purpose |
|------|---------|
| `wrangler.toml` | Worker configuration |
| `src/index.js` | Worker entry point — handles requests, RAG logic, Gemini API calls |
| `src/rag_index.json` | Pre-computed embeddings index (generated by `build_rag_index.py`) |
| `package.json` | Node dependencies |

## Cost

- **Cloudflare Workers free tier**: 100,000 requests/day
- **Gemini API**: Each chat message makes 2 API calls (1 embedding + 1 generation). The free tier allows 15 requests/minute and 1,500/day, which is sufficient for a personal site.
