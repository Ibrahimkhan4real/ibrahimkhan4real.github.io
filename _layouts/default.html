<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Muhammad Ibrahim Khan">
  <title>{{ page.title | default: "Muhammad Ibrahim Khan" }}</title>
  <meta name="description" content="{{ page.description | default: "Muhammad Ibrahim Khan — PhD researcher at Coventry University working on reinforcement learning and Monte Carlo Tree Search for predictive control of energy systems." }}">
  <meta property="og:title" content="{{ page.title | default: "Muhammad Ibrahim Khan" }}">
  <meta property="og:description" content="{{ page.description | default: "PhD researcher at Coventry University working on reinforcement learning and Monte Carlo Tree Search for predictive control of energy systems." }}">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ page.url | absolute_url }}">
  <meta property="og:image" content="{{ "/assets/img/Khan_logo.jpg" | absolute_url }}">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="{{ page.title | default: "Muhammad Ibrahim Khan" }}">
  <meta name="twitter:description" content="{{ page.description | default: "PhD researcher at Coventry University working on reinforcement learning and Monte Carlo Tree Search for predictive control of energy systems." }}">
  <meta name="twitter:image" content="{{ "/assets/img/Khan_logo.jpg" | absolute_url }}">
  <link rel="canonical" href="{{ page.url | absolute_url }}">
  <link rel="icon" href="{{ "/assets/img/favicon.svg" | relative_url }}" type="image/svg+xml">
  <link rel="stylesheet" href="{{ "/assets/css/site.css?v=20260217_v4" | relative_url }}">
  {% if page.use_math %}
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  {% endif %}
  <script>
    // Theme initialization
    (function() {
      const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();
  </script>
</head>
<body>
  <div id="reading-progress"></div>

  <aside>
    <div id="user_meta">
      <div id="author_info">
        <a href="{{ "/" | relative_url }}">
          <img src="{{ "/assets/img/Khan_logo.jpg" | relative_url }}" alt="Muhammad Ibrahim Khan logo" width="192" height="192">
        </a>
        <h2><a href="{{ "/" | relative_url }}">Muhammad Ibrahim Khan</a></h2>
      </div>
      <ul>
        <li>
          <a class="nav-link{% if page.url == "/" or page.url == "/index.html" %} current{% endif %}" href="{{ "/" | relative_url }}">Home</a>
        </li>
        <li>
          <a class="nav-link{% if page.url == "/live.html" %} current{% endif %}" href="{{ "/live.html" | relative_url }}">Live</a>
        </li>
        <li>
          <a class="nav-link{% if page.url == "/travel.html" %} current{% endif %}" href="{{ "/travel.html" | relative_url }}">Travel</a>
        </li>
        <li>
          <a class="nav-link{% if page.url == "/demos.html" %} current{% endif %}" href="{{ "/demos.html" | relative_url }}">Demos</a>
        </li>
        <li>
          <a class="nav-link{% if page.url == "/papers.html" %} current{% endif %}" href="{{ "/papers.html" | relative_url }}">Papers</a>
        </li>
        <li>
          <a class="nav-link{% if page.url == "/blog.html" %} current{% endif %}" href="{{ "/blog.html" | relative_url }}">Blog</a>
        </li>
        <li>
          <a class="nav-link" href="{{ "/index.html#contact" | relative_url }}">Contact</a>
        </li>
        <li>
          <a class="nav-link" href="https://github.com/Ibrahimkhan4real" target="_blank" rel="noopener noreferrer">GitHub</a>
        </li>
        <li>
          <button class="nav-link theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            <span class="theme-toggle-label">Dark mode</span>
          </button>
        </li>
      </ul>
    </div>
  </aside>

  <main>
    {{ content }}
  </main>

  <!-- RAG Chatbot Widget -->
  <div id="chat-widget" class="minimized">
    <div id="chat-header">
      <span>Ask about my research</span>
      <span id="chat-toggle">&#9650;</span>
    </div>
    <div id="chat-messages">
      <div class="chat-message bot">Hi! I can answer questions about Ibrahim's research, publications, experience, and skills. What would you like to know?</div>
    </div>
    <div id="chat-input-container">
      <input type="text" id="chat-input" placeholder="e.g. What is your PhD about?" autocomplete="off" aria-label="Ask a question about Ibrahim's research">
      <button id="chat-send">Send</button>
    </div>
  </div>

  <script>
    // Theme Toggle Logic
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', nextTheme);
      localStorage.setItem('theme', nextTheme);
    });

    // Reading Progress Logic
    window.addEventListener('scroll', () => {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      document.getElementById('reading-progress').style.width = scrolled + "%";
    });

    // Chat Widget Logic
    (function() {
      const CHAT_API = 'https://ibrahim-research-chat.YOUR_CF_SUBDOMAIN.workers.dev';
      const chatWidget = document.getElementById('chat-widget');
      const chatHeader = document.getElementById('chat-header');
      const chatToggleEl = document.getElementById('chat-toggle');
      const chatInput = document.getElementById('chat-input');
      const chatSend = document.getElementById('chat-send');
      const chatMessages = document.getElementById('chat-messages');
      let chatHistory = [];
      let sending = false;

      chatHeader.addEventListener('click', () => {
        chatWidget.classList.toggle('minimized');
        chatToggleEl.textContent = chatWidget.classList.contains('minimized') ? '\u25B2' : '\u25BC';
      });

      function addMessage(text, side) {
        const msg = document.createElement('div');
        msg.className = 'chat-message ' + side;
        msg.textContent = text;
        chatMessages.appendChild(msg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return msg;
      }

      function setInputEnabled(enabled) {
        chatInput.disabled = !enabled;
        chatSend.disabled = !enabled;
        sending = !enabled;
      }

      async function sendQuery(text) {
        addMessage(text, 'user');
        chatHistory.push({ role: 'user', text: text });
        chatInput.value = '';
        setInputEnabled(false);

        const thinkingMsg = addMessage('Thinking...', 'bot');

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const resp = await fetch(CHAT_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: text,
              history: chatHistory.slice(-6),
            }),
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error || 'Request failed');
          }

          const data = await resp.json();
          thinkingMsg.textContent = data.answer || 'No response received.';
          chatHistory.push({ role: 'assistant', text: data.answer });
        } catch (err) {
          thinkingMsg.textContent = err.name === 'AbortError'
            ? 'Request timed out. The backend may be unavailable — please try again later.'
            : 'Sorry, I could not connect to the backend. Please try again later.';
          console.error('Chat error:', err);
        } finally {
          setInputEnabled(true);
          chatInput.focus();
        }
      }

      chatSend.addEventListener('click', () => {
        const text = chatInput.value.trim();
        if (text && !sending) sendQuery(text);
      });

      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') chatSend.click();
      });
    })();
  </script>
</body>
</html>
